name: Deploy PyConTW sites to branch

on:
  push:
    branches:
      [main]

jobs:
  deploy-pycontw2016:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          token: '${{ secrets.ACCESS_TOKEN }}'
          fetch-depth: 0
      - name: Set up Python
        uses: actions/setup-python@v1
        with:
          python-version: '3.x'
      - name: Install dependencies
        run: |
          python -m pip install -U pip pipenv
          pipenv install
      - name: Crawl PyConTW 2016
        run: |
          pipenv run python3 main.py -y 2016
      - name: Push downloaded files to branch
        env:
          SECRET: '${{ secrets.ACCESS_TOKEN }}'
          USER_NAME: githubaction
          USER_EMAIL: githubaction@fake.com
          PUBLISH_DIR: ./2016
          BRANCH_NAME: pycontw-2016
        run: |
          cd $PUBLISH_DIR
          git init
          git config --local user.name $USER_NAME
          git config --local user.email $USER_EMAIL
          git status
          git remote add origin https://$SECRET@github.com/$GITHUB_REPOSITORY.git
          git fetch --no-recurse-submodules
          git ls-remote --heads origin $BRANCH_NAME | wc -l
          git checkout -b $BRANCH_NAME
          git worktree add --checkout remote-$BRANCH_NAME origin/$BRANCH_NAME
          rsync -q -av --checksum --progress . remote-$BRANCH_NAME --delete --exclude .git --exclude remote-$BRANCH_NAME
          cd remote-$BRANCH_NAME
          git status --porcelain
          git add --all
          git checkout -b $BRANCH_NAME
          git commit -m "Deploy PyConTW 2016 to branch $BRANCH_NAME"
          git push -f origin $BRANCH_NAME
          cd ..
          git worktree remove remote-$BRANCH_NAME --force
          echo "Deploy $BRANCH_NAME completed successfully"
  deploy-pycontw2017:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          token: '${{ secrets.ACCESS_TOKEN }}'
          fetch-depth: 0
      - name: Set up Python
        uses: actions/setup-python@v1
        with:
          python-version: '3.x'
      - name: Install dependencies
        run: |
          python -m pip install -U pip pipenv
          pipenv install
      - name: Crawl PyConTW 2017
        run: |
          pipenv run python3 main.py -y 2017
      - name: Push downloaded files to branch
        env:
          SECRET: '${{ secrets.ACCESS_TOKEN }}'
          USER_NAME: githubaction
          USER_EMAIL: githubaction@fake.com
          PUBLISH_DIR: ./2017
          BRANCH_NAME: pycontw-2017
        run: |
          cd $PUBLISH_DIR
          git init
          git config --local user.name $USER_NAME
          git config --local user.email $USER_EMAIL
          git status
          git remote add origin https://$SECRET@github.com/$GITHUB_REPOSITORY.git
          git fetch --no-recurse-submodules
          git ls-remote --heads origin $BRANCH_NAME | wc -l
          git checkout -b $BRANCH_NAME
          git worktree add --checkout remote-$BRANCH_NAME origin/$BRANCH_NAME
          rsync -q -av --checksum --progress . remote-$BRANCH_NAME --delete --exclude .git --exclude remote-$BRANCH_NAME
          cd remote-$BRANCH_NAME
          git status --porcelain
          git add --all
          git checkout -b $BRANCH_NAME
          git commit -m "Deploy PyConTW 2017 to branch $BRANCH_NAME"
          git push -f origin $BRANCH_NAME
          cd ..
          git worktree remove remote-$BRANCH_NAME --force
          echo "Deploy $BRANCH_NAME completed successfully"
  deploy-pycontw2018:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          token: '${{ secrets.ACCESS_TOKEN }}'
          fetch-depth: 0
      - name: Set up Python
        uses: actions/setup-python@v1
        with:
          python-version: '3.x'
      - name: Install dependencies
        run: |
          python -m pip install -U pip pipenv
          pipenv install
      - name: Crawl PyConTW 2018
        run: |
          pipenv run python3 main.py -y 2018
      - name: Push downloaded files to branch
        env:
          SECRET: '${{ secrets.ACCESS_TOKEN }}'
          USER_NAME: githubaction
          USER_EMAIL: githubaction@fake.com
          PUBLISH_DIR: ./2018
          BRANCH_NAME: pycontw-2018
        run: |
          cd $PUBLISH_DIR
          git init
          git config --local user.name $USER_NAME
          git config --local user.email $USER_EMAIL
          git status
          git remote add origin https://$SECRET@github.com/$GITHUB_REPOSITORY.git
          git fetch --no-recurse-submodules
          git ls-remote --heads origin $BRANCH_NAME | wc -l
          git checkout -b $BRANCH_NAME
          git worktree add --checkout remote-$BRANCH_NAME origin/$BRANCH_NAME
          rsync -q -av --checksum --progress . remote-$BRANCH_NAME --delete --exclude .git --exclude remote-$BRANCH_NAME
          cd remote-$BRANCH_NAME
          git status --porcelain
          git add --all
          git checkout -b $BRANCH_NAME
          git commit -m "Deploy PyConTW 2018 to branch $BRANCH_NAME"
          git push -f origin $BRANCH_NAME
          cd ..
          git worktree remove remote-$BRANCH_NAME --force
          echo "Deploy $BRANCH_NAME completed successfully"
  deploy-pycontw2019:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          token: '${{ secrets.ACCESS_TOKEN }}'
          fetch-depth: 0
      - name: Set up Python
        uses: actions/setup-python@v1
        with:
          python-version: '3.x'
      - name: Install dependencies
        run: |
          python -m pip install -U pip pipenv
          pipenv install
      - name: Crawl PyConTW 2019
        run: |
          pipenv run python3 main.py -y 2019
      - name: Push downloaded files to branch
        env:
          SECRET: '${{ secrets.ACCESS_TOKEN }}'
          USER_NAME: githubaction
          USER_EMAIL: githubaction@fake.com
          PUBLISH_DIR: ./2019
          BRANCH_NAME: pycontw-2019
        run: |
          cd $PUBLISH_DIR
          git init
          git config --local user.name $USER_NAME
          git config --local user.email $USER_EMAIL
          git status
          git remote add origin https://$SECRET@github.com/$GITHUB_REPOSITORY.git
          git fetch --no-recurse-submodules
          git ls-remote --heads origin $BRANCH_NAME | wc -l
          git checkout -b $BRANCH_NAME
          git worktree add --checkout remote-$BRANCH_NAME origin/$BRANCH_NAME
          rsync -q -av --checksum --progress . remote-$BRANCH_NAME --delete --exclude .git --exclude remote-$BRANCH_NAME
          cd remote-$BRANCH_NAME
          git status --porcelain
          git add --all
          git checkout -b $BRANCH_NAME
          git commit -m "Deploy PyConTW 2019 to branch $BRANCH_NAME"
          git push -f origin $BRANCH_NAME
          cd ..
          git worktree remove remote-$BRANCH_NAME --force
          echo "Deploy $BRANCH_NAME completed successfully"
  deploy-pycontw2020:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          token: '${{ secrets.ACCESS_TOKEN }}'
          fetch-depth: 0
      - name: Set up Python
        uses: actions/setup-python@v1
        with:
          python-version: '3.x'
      - name: Install dependencies
        run: |
          python -m pip install -U pip pipenv
          pipenv install
      - name: Crawl PyConTW 2020
        run: |
          pipenv run python3 main.py -y 2020
      - name: Push downloaded files to branch
        env:
          SECRET: '${{ secrets.ACCESS_TOKEN }}'
          USER_NAME: githubaction
          USER_EMAIL: githubaction@fake.com
          PUBLISH_DIR: ./2020
          BRANCH_NAME: pycontw-2020
        run: |
          cd $PUBLISH_DIR
          git init
          git config --local user.name $USER_NAME
          git config --local user.email $USER_EMAIL
          git status
          git remote add origin https://$SECRET@github.com/$GITHUB_REPOSITORY.git
          git fetch --no-recurse-submodules
          git ls-remote --heads origin $BRANCH_NAME | wc -l
          git checkout -b $BRANCH_NAME
          git worktree add --checkout remote-$BRANCH_NAME origin/$BRANCH_NAME
          rsync -q -av --checksum --progress . remote-$BRANCH_NAME --delete --exclude .git --exclude remote-$BRANCH_NAME
          cd remote-$BRANCH_NAME
          git status --porcelain
          git add --all
          git checkout -b $BRANCH_NAME
          git commit -m "Deploy PyConTW 2020 to branch $BRANCH_NAME"
          git push -f origin $BRANCH_NAME
          cd ..
          git worktree remove remote-$BRANCH_NAME --force
          echo "Deploy $BRANCH_NAME completed successfully"